<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Absensi</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat PapaParse untuk membaca file CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Memuat SheetJS (xlsx.js) untuk membaca file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Memuat plugin Datalabels untuk Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Style tambahan untuk tampilan yang lebih baik */
        #messageBox, #debugArea, #dashboardArea, #resultsArea, #summaryArea, #filterArea {
            transition: opacity 0.3s ease-in-out;
        }
        .summary-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            align-items: center;
        }
        .summary-card .icon {
            flex-shrink: 0;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-7xl mx-auto">

            <!-- Judul Utama -->
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Monitoring Absensi Karyawan</h1>
                <p class="text-gray-600 mt-2 text-lg">Kemenangan Jaya Karawang</p>
            </div>

            <!-- Langkah 1: Unggah File -->
            <div class="mb-10">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Langkah 1: Unggah File</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="employeeListFile" class="block text-sm font-medium text-gray-700 mb-2">Unggah Daftar Nama</label>
                        <input type="file" id="employeeListFile" accept=".csv, .txt, .xls, .xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div>
                        <label for="fingerprintFile" class="block text-sm font-medium text-gray-700 mb-2">Unggah Data Mentah</label>
                        <input type="file" id="fingerprintFile" accept=".csv, .xls, .xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="processButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Proses Data</button>
                </div>
            </div>
            
            <div id="messageBox" class="text-center p-4 mb-6 rounded-lg" style="display: none;"></div>

            <!-- Langkah 2: Dashboard & Filter -->
            <div id="dashboardContainer" class="hidden mb-10">
                 <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Langkah 2: Dashboard & Analisis</h2>
                <!-- Area Dashboard Ringkasan -->
                <div id="dashboardArea" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Cards will be generated here -->
                </div>
                <!-- Area Filter -->
                <div id="filterArea" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label for="employeeFilter" class="block text-sm font-medium text-gray-700">Pilih Karyawan (Ctrl+Klik)</label>
                        <select id="employeeFilter" multiple class="mt-1 block w-full h-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="startDateFilter" class="block text-sm font-medium text-gray-700">Dari Tanggal</label>
                        <input type="date" id="startDateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="endDateFilter" class="block text-sm font-medium text-gray-700">Sampai Tanggal</label>
                        <input type="date" id="endDateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                </div>
            </div>

            <!-- Langkah 3: Ringkasan, Grafik, dan Detail -->
            <div id="reportsContainer" class="hidden">
                 <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Langkah 3: Laporan & Grafik</h2>
                <!-- Area Ringkasan & Grafik -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-10">
                    <div id="summaryArea" class="lg:col-span-3">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Ringkasan per Karyawan</h3>
                            <button id="exportSummaryButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 text-sm">Ekspor Ringkasan</button>
                        </div>
                        <div class="overflow-auto max-h-96">
                            <table class="min-w-full bg-white border-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jml. Masuk</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jml. Off</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tepat Waktu</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Terlambat</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTableBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="chartContainer" class="lg:col-span-2 flex flex-col items-center">
                         <div class="flex justify-between items-center w-full mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Grafik Kehadiran</h3>
                            <button id="downloadChartButton" class="bg-gray-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md hover:bg-gray-700 text-xs">Unduh Grafik</button>
                         </div>
                         <div class="relative h-64 w-full">
                            <canvas id="attendanceChart"></canvas>
                         </div>
                    </div>
                </div>

                <!-- Area Hasil Detail Harian -->
                <div id="resultsArea">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Laporan Detail Harian</h3>
                        <button id="exportDetailButton" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 text-sm">Ekspor Detail</button>
                    </div>
                    <div class="overflow-auto max-h-96">
                        <table class="min-w-full bg-white border-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Departemen</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hari</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Masuk</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Keluar</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="debugArea" class="hidden mt-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Log Pemrosesan</h3>
                <div id="debugLog" class="rounded-md"></div>
            </div>
            
            <!-- Footer -->
            <footer class="text-center mt-10 pt-6 border-t">
                <p class="text-sm text-gray-500">dibuat oleh : Yudi Pratama</p>
            </footer>
        </div>
    </div>

    <script>
        const elInput = document.getElementById('employeeListFile');
        const fpInput = document.getElementById('fingerprintFile');
        const procBtn = document.getElementById('processButton');
        const msgBox = document.getElementById('messageBox');
        const dashCont = document.getElementById('dashboardContainer');
        const repCont = document.getElementById('reportsContainer');
        const dashArea = document.getElementById('dashboardArea');
        const resArea = document.getElementById('resultsArea');
        const sumArea = document.getElementById('summaryArea');
        const dbgArea = document.getElementById('debugArea');
        const resTblBody = document.getElementById('resultsTableBody');
        const sumTblBody = document.getElementById('summaryTableBody');
        const dbgLog = document.getElementById('debugLog');
        const expDetBtn = document.getElementById('exportDetailButton');
        const expSumBtn = document.getElementById('exportSummaryButton');
        const empFilter = document.getElementById('employeeFilter');
        const startFilter = document.getElementById('startDateFilter');
        const endFilter = document.getElementById('endDateFilter');
        const chartCanvas = document.getElementById('attendanceChart');
        const dlChartBtn = document.getElementById('downloadChartButton');
        let allData = [];
        let chartInst = null;
        const shiftRules = {
            'Pagi': {
                jamMasukIdeal: '08:30',
                jamKeluarIdeal: '17:30'
            },
            'Shift Siang': {
                jamMasukIdeal: '12:15',
                jamKeluarIdeal: '21:00'
            },
        };

        function showMsg(msg, type = 'info') {
            msgBox.textContent = msg;
            msgBox.style.display = 'block';
            msgBox.className = 'text-center p-4 mb-6 rounded-lg ';
            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-100', 'text-red-800');
            } else {
                msgBox.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        function parseDt(dtStr) {
            const parts = dtStr.split('/');
            let date = new Date(`${parts[2]}-${parts[0]}-${parts[1]}`);
            if (isNaN(date.getTime())) {
                date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
            }
            return date;
        }
        procBtn.addEventListener('click', handleProcData);
        [empFilter, startFilter, endFilter].forEach(el => {
            el.addEventListener('change', () => applyFilters());
        });
        expDetBtn.addEventListener('click', () => exportCSV(true));
        expSumBtn.addEventListener('click', () => exportCSV(false));
        dlChartBtn.addEventListener('click', () => {
            if (chartInst) {
                const link = document.createElement('a');
                link.href = chartInst.toBase64Image('image/png', 1);
                link.download = 'grafik_kehadiran.png';
                link.click();
            }
        });
        async function handleProcData() {
            if (!elInput.files[0] || !fpInput.files[0]) {
                showMsg('Mohon unggah kedua file.', 'error');
                return;
            }
            showMsg('Mohon tunggu, data sedang diproses...', 'info');
            [dashCont, repCont, dbgArea].forEach(el => el.classList.add('hidden'));
            try {
                const [empListData, rawFpData] = await Promise.all([procFile(elInput.files[0], false), procFile(fpInput.files[0], true)]);
                if (rawFpData.length < 2) {
                    showMsg('File data mentah kosong atau tidak valid.', 'error');
                    return;
                }
                // DIPERBARUI: Menghapus .sort() untuk mempertahankan urutan asli
                const origEmpNames = [...new Set(empListData.map(name => String(name).trim()))];
                popEmpFilter(origEmpNames);
                const attendance = new Map();
                const unmatched = new Set();
                let numericOrEmpty = 0;
                const allDates = new Set();
                const empDepts = new Map();
                for (let i = 1; i < rawFpData.length; i++) {
                    const row = rawFpData[i];
                    if (row.length < 5) continue;
                    const shortNameRaw = row[1] ? String(row[1]).trim() : '';
                    const dept = row[2] ? String(row[2]).trim() : 'N/A';
                    const dateStr = row[3];
                    const timeStr = row[4];
                    if (!shortNameRaw || !isNaN(shortNameRaw)) {
                        numericOrEmpty++;
                        continue;
                    }
                    if (!dateStr || !timeStr) continue;
                    allDates.add(dateStr);
                    
                    let matchedFullName = null;
                    const shortNameLower = shortNameRaw.toLowerCase();
                    
                    let bestMatch = { name: null, score: 0 };
                    for (const fullName of origEmpNames) {
                        const fullNameLower = fullName.toLowerCase();
                        let currentScore = 0;

                        const shortNameFirstWord = shortNameLower.split(' ')[0];
                        const fullNameFirstWord = fullNameLower.split(' ')[0];

                        if (fullNameLower === shortNameLower) {
                            currentScore = 100;
                        } else if (fullNameFirstWord === shortNameFirstWord) {
                            currentScore = 90;
                        } else if (fullNameLower.includes(shortNameLower)) {
                            currentScore = 80;
                        }
                        
                        if (currentScore > bestMatch.score) {
                            bestMatch = { name: fullName, score: currentScore };
                        }
                    }
                    matchedFullName = bestMatch.name;

                    if (matchedFullName) {
                         if (!empDepts.has(matchedFullName) && dept !== 'N/A') {
                            empDepts.set(matchedFullName, dept);
                        }
                        const times = String(timeStr).match(/\d{2}:\d{2}/g) || [];
                        if (times.length === 0) continue;
                        const firstIn = times.reduce((a, b) => (b < a ? b : a));
                        const lastOut = times.length > 1 ? times.reduce((a, b) => (b > a ? b : a)) : firstIn;
                        const key = `${matchedFullName.toLowerCase()}-${dateStr}`;
                        let shiftName = (firstIn >= '11:00') ? 'Shift Siang' : 'Pagi';
                        const rule = shiftRules[shiftName];
                        let status = '';
                        if (firstIn === lastOut) {
                            status = 'Hanya 1x Scan';
                        } else if (new Date(`1970-01-01T${lastOut}:00`) < new Date(`1970-01-01T${rule.jamKeluarIdeal}:00`)) {
                            status = 'Pulang Cepat';
                        } else if ((shiftName === 'Pagi' || shiftName === 'Shift Siang') && (new Date(`1970-01-01T${lastOut}:00`) - new Date(`1970-01-01T${rule.jamKeluarIdeal}:00`) >= 30 * 60 * 1000)) {
                            status = 'Loyalitas';
                        } else if (firstIn > rule.jamMasukIdeal) {
                            status = 'Terlambat';
                        } else {
                            status = 'Tepat Waktu';
                        }
                        const dateObj = parseDt(dateStr);
                        const dayName = !isNaN(dateObj.getTime()) ? dateObj.toLocaleDateString('id-ID', {
                            weekday: 'long'
                        }) : 'Invalid';
                        attendance.set(key, {
                            name: matchedFullName,
                            department: dept,
                            day: dayName,
                            date: dateStr,
                            shift: shiftName,
                            firstIn,
                            lastOut,
                            status
                        });
                    } else {
                        unmatched.add(shortNameRaw);
                    }
                }
                const procData = Array.from(attendance.values());
                const datesInRange = Array.from(allDates);
                origEmpNames.forEach(empName => {
                    datesInRange.forEach(dateStr => {
                        const key = `${empName.toLowerCase()}-${dateStr}`;
                        if (!attendance.has(key)) {
                            const dateObj = parseDt(dateStr);
                            const dayName = !isNaN(dateObj.getTime()) ? dateObj.toLocaleDateString('id-ID', {
                                weekday: 'long'
                            }) : 'Invalid';
                            procData.push({
                                name: empName,
                                department: empDepts.get(empName) || 'N/A',
                                day: dayName,
                                date: dateStr,
                                shift: '-',
                                firstIn: '-',
                                lastOut: '-',
                                status: 'Off'
                            });
                        }
                    });
                });
                // DIPERBARUI: Mengurutkan berdasarkan urutan daftar nama, lalu tanggal
                allData = procData.sort((a, b) => {
                    const indexA = origEmpNames.indexOf(a.name);
                    const indexB = origEmpNames.indexOf(b.name);
                    if (indexA < indexB) return -1;
                    if (indexA > indexB) return 1;
                    return parseDt(a.date) - parseDt(b.date);
                });
                applyFilters();
                const procCount = allData.length;
                if (procCount > 0) {
                    showMsg(`Berhasil! ${allData.filter(d=>d.status !== 'Off').length} data kehadiran dan ${allData.filter(d=>d.status === 'Off').length} data Off berhasil diproses.`, 'success');
                    [dashCont, repCont].forEach(el => el.classList.remove('hidden'));
                } else {
                    showMsg('Tidak ada data yang cocok. Periksa Log Pemrosesan.', 'error');
                }
                dispDbgInfo(rawFpData.length - 1, origEmpNames.length, unmatched, numericOrEmpty, procCount);
            } catch (error) {
                console.error('Terjadi kesalahan saat memproses file:', error);
                showMsg(`Terjadi kesalahan: ${error.message}`, 'error');
            }
        }

        function popEmpFilter(empList) {
            empFilter.innerHTML = '<option value="semua" selected>Semua Karyawan</option>';
            empList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                empFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const selOpts = Array.from(empFilter.selectedOptions).map(opt => opt.value);
            const startDate = startFilter.value;
            const endDate = endFilter.value;
            let filtData = allData.filter(item => {
                const nameMatch = selOpts.includes('semua') || selOpts.length === 0 || selOpts.includes(item.name);
                const itemDate = parseDt(item.date);
                const startMatch = !startDate || itemDate >= new Date(startDate);
                const endMatch = !endDate || itemDate <= new Date(endDate);
                return nameMatch && startMatch && endMatch;
            });
            const sumData = procSumData(filtData);
            dispResults(filtData);
            dispSummary(sumData);
            updDashCards(sumData);
            drawChart(sumData);
        }

        function procSumData(filtDetData) {
            const sumMap = new Map();
            filtDetData.forEach(data => {
                if (!sumMap.has(data.name)) {
                    sumMap.set(data.name, {
                        department: data.department,
                        totalMasuk: 0,
                        off: 0,
                        tepatWaktu: 0,
                        terlambat: 0,
                        pulangCepat: 0,
                        loyalitas: 0,
                    });
                }
                const summary = sumMap.get(data.name);
                if (data.status !== 'Off') {
                    summary.totalMasuk++;
                }
                switch (data.status) {
                    case 'Tepat Waktu':
                        summary.tepatWaktu++;
                        break;
                    case 'Terlambat':
                        summary.terlambat++;
                        break;
                    case 'Pulang Cepat':
                        summary.pulangCepat++;
                        break;
                    case 'Loyalitas':
                        summary.loyalitas++;
                        break;
                    case 'Off':
                        summary.off++;
                        break;
                }
            });
            // DIPERBARUI: Mengurutkan ringkasan sesuai urutan daftar nama
            const sortedSummary = Array.from(sumMap.entries()).sort((a, b) => {
                const originalOrder = Array.from(document.querySelectorAll('#employeeFilter option')).map(opt => opt.value);
                return originalOrder.indexOf(a[0]) - originalOrder.indexOf(b[0]);
            }).map(([name, data]) => ({ name, ...data }));

            return sortedSummary;
        }

        function updDashCards(sumData) {
            const totalEmp = new Set(sumData.map(s => s.name)).size;
            const totalHadir = sumData.reduce((acc, cur) => acc + cur.totalMasuk, 0);
            const totalTerlambat = sumData.reduce((acc, cur) => acc + cur.terlambat, 0);
            const totalPulangCepat = sumData.reduce((acc, cur) => acc + cur.pulangCepat, 0);
            dashArea.innerHTML = `<div class="summary-card"><div class="icon bg-blue-100 text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div><div><p class="text-gray-500 text-sm">Karyawan Aktif</p><p class="text-2xl font-bold">${totalEmp}</p></div></div><div class="summary-card"><div class="icon bg-green-100 text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div><div><p class="text-gray-500 text-sm">Total Kehadiran</p><p class="text-2xl font-bold">${totalHadir}</p></div></div><div class="summary-card"><div class="icon bg-red-100 text-red-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="text-gray-500 text-sm">Total Terlambat</p><p class="text-2xl font-bold">${totalTerlambat}</p></div></div><div class="summary-card"><div class="icon bg-yellow-100 text-yellow-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="text-gray-500 text-sm">Total Pulang Cepat</p><p class="text-2xl font-bold">${totalPulangCepat}</p></div></div>`;
        }

        function dispSummary(sumData) {
            sumTblBody.innerHTML = '';
            sumData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${data.name}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.totalMasuk}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.off}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-green-600 font-semibold">${data.tepatWaktu}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 font-semibold">${data.terlambat}</td>`;
                sumTblBody.appendChild(row);
            });
        }

        function dispResults(detData) {
            resTblBody.innerHTML = '';
            detData.forEach(data => {
                const statusClasses = {
                    'Hanya 1x Scan': 'text-gray-600',
                    'Tepat Waktu': 'text-green-600',
                    'Terlambat': 'text-red-600',
                    'Pulang Cepat': 'text-yellow-600',
                    'Loyalitas': 'text-purple-600 font-semibold',
                    'Off': 'text-blue-600'
                };
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${data.name}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.department}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.day}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.date}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.shift}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.firstIn}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data.lastOut}</td><td class="px-4 py-2 whitespace-nowrap text-sm ${statusClasses[data.status] || ''}">${data.status}</td>`;
                resTblBody.appendChild(row);
            });
        }
        Chart.register(ChartDataLabels);

        function drawChart(sumData) {
            if (chartInst) {
                chartInst.destroy();
            }
            const totalTW = sumData.reduce((acc, cur) => acc + cur.tepatWaktu, 0);
            const totalT = sumData.reduce((acc, cur) => acc + cur.terlambat, 0);
            const totalPC = sumData.reduce((acc, cur) => acc + cur.pulangCepat, 0);
            chartInst = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: ['Tepat Waktu', 'Terlambat', 'Pulang Cepat'],
                    datasets: [{
                        label: 'Jumlah Kasus',
                        data: [totalTW, totalT, totalPC],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: Math.round,
                            font: {
                                weight: 'bold'
                            },
                            color: '#4A5568'
                        }
                    }
                }
            });
        }

        function dispDbgInfo(rawTotal, listTotal, unmatched, numeric, processed) {
            let logContent = `• Total baris data di file mentah: ${rawTotal}\n`;
            logContent += `• Total nama unik di daftar nama: ${listTotal}\n`;
            logContent += `• Total baris berhasil diproses (termasuk Off): ${processed}\n\n`;
            if (numeric > 0) logContent += `📌 Ditemukan ${numeric} baris dilewati karena 'Nama' berisi angka/kosong.\n\n`;
            if (unmatched.size > 0) {
                logContent += '📌 Nama berikut tidak cocok dengan daftar nama Anda:\n' + Array.from(unmatched).join(', ');
            } else if (processed === 0 && rawTotal > 0) {
                logContent += '📌 Tidak ada nama yang cocok. Pastikan kedua file berisi nama yang sama.';
            }
            dbgLog.textContent = logContent;
            dbgArea.classList.remove('hidden');
        }

        function exportCSV(isDetail) {
            let dataToExport, headers, filename;
            const selOpts = Array.from(empFilter.selectedOptions).map(opt => opt.value);
            const startDate = startFilter.value;
            const endDate = endFilter.value;
            let baseData = allData.filter(item => {
                const nameMatch = selOpts.includes('semua') || selOpts.length === 0 || selOpts.includes(item.name);
                const itemDate = parseDt(item.date);
                const startMatch = !startDate || itemDate >= new Date(startDate);
                const endMatch = !endDate || itemDate <= new Date(endDate);
                return nameMatch && startMatch && endMatch;
            });
            if (isDetail) {
                dataToExport = baseData;
                headers = ['name', 'department', 'day', 'date', 'shift', 'firstIn', 'lastOut', 'status'];
                filename = 'laporan_detail_harian.csv';
            } else {
                dataToExport = procSumData(baseData);
                headers = ['name', 'department', 'totalMasuk', 'off', 'tepatWaktu', 'terlambat', 'pulangCepat', 'loyalitas'];
                filename = 'laporan_ringkasan_karyawan.csv';
            }
            const csvRows = [];
            csvRows.push(headers.join(','));
            for (const row of dataToExport) {
                const values = headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`);
                csvRows.push(values.join(','));
            }
            const blob = new Blob([csvRows.join('\n')], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function procFile(file, isRaw) {
            return new Promise((resolve, reject) => {
                const fName = file.name.toLowerCase();
                const reader = new FileReader();
                if (fName.endsWith('.csv') || fName.endsWith('.txt')) {
                    Papa.parse(file, {
                        header: false,
                        skipEmptyLines: true,
                        complete: (res) => resolve(isRaw ? res.data : res.data.flat().filter(Boolean)),
                        error: (err) => reject(err),
                    });
                } else if (fName.endsWith('.xls') || fName.endsWith('.xlsx')) {
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, {
                                type: 'array'
                            });
                            const firstSheet = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheet];
                            const aoaData = XLSX.utils.sheet_to_json(worksheet, {
                                header: 1,
                                raw: false,
                                dateNF: 'mm/dd/yyyy'
                            });
                            resolve(isRaw ? aoaData : aoaData.flat().filter(Boolean));
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsArrayBuffer(file);
                } else {
                    reject(new Error('Format file tidak didukung.'));
                }
            });
        }
    </script>

</body>
</html>
